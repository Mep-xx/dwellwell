generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   Enums
   ========================= */

enum Units {
  imperial
  metric
}

enum HouseholdRole {
  owner
  renter
  property_manager
}

enum DiySkill {
  none
  beginner
  intermediate
  pro
}

enum AuthProvider {
  local
  google
}

enum FlooringType {
  carpet
  hardwood
  laminate
  tile
  vinyl
  stone
  concrete
  other
}

enum WallFinish {
  painted_drywall
  wallpaper
  wood_paneling
  plaster
  other
}

enum CeilingType {
  drywall
  drop_ceiling
  exposed_beams
  skylight
  other
}

enum WindowType {
  none
  single_hung
  double_hung
  casement
  awning
  bay
  slider
  fixed
  skylight
  other
}

enum CeilingFixture {
  none
  flushmount
  chandelier
  fan_only
  fan_with_light
  recessed
  track
  mixed
}

enum TrackableStatus {
  IN_USE
  PAUSED
  RETIRED
}

enum RetiredReason {
  BROKEN
  SOLD
  REPLACED
  OTHER
}

enum TemplateState {
  DRAFT
  VERIFIED
}

enum UserTaskSourceType {
  room
  trackable
}

enum TaskStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum TaskCriticality {
  low
  medium
  high
}

enum TaskType {
  GENERAL
  AI_GENERATED
  USER_DEFINED
}

enum TrackableResourceType {
  pdf
  video
}

/* ---------- Settings enums ---------- */
enum ThemeMode {
  LIGHT
  DARK
  SYSTEM
}

enum GamificationVisibility {
  PRIVATE
  PUBLIC
  HIDDEN_UI_KEEP_STATS
}

enum NotificationEvent {
  TASK_DUE_SOON
  TASK_OVERDUE
  WEEKLY_DIGEST
  NEW_TASKS_ADDED
  TRACKABLE_MILESTONE
  GAMIFICATION_LEVEL_UP
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
}

enum NotificationFrequency {
  IMMEDIATE
  DAILY_DIGEST
  WEEKLY_DIGEST
}

/* ---------- Generic/detail provenance ---------- */
enum DetailLevel {
  generic     // quick-added, no brand/model
  basic       // brand OR a few details
  detailed    // brand + model (maybe serial missing)
  verified    // full details incl. serial/warranty
}

enum TrackableSource {
  user_manual_entry
  user_quick_prompt
  admin_seed
  import_csv
  catalog_match
}

/* =========================
   Identity & Accounts
   ========================= */

model User {
  id                String       @id @default(uuid())
  email             String       @unique
  passwordHash      String?
  authProvider      AuthProvider @default(local)
  passwordUpdatedAt DateTime?
  failedLoginCount  Int          @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime     @default(now())

  googleId String? @unique
  role     String  @default("user")

  // Primary relations
  homes            Home[]              @relation("UserHome")
  trackablesOwned  Trackable[]         @relation("UserOwnsTrackables")
  userTasks        UserTask[]
  loginActivities  LoginActivity[]
  billingAccount   BillingAccount?
  aiQueries        AIQueryHistory[]
  dismissedTasks   DismissedUserTask[]
  refreshSessions  RefreshSession[]
  lifecycleEvents  LifecycleEvent[]

  // Default home
  defaultHomeId String? @map("defaultHomeId")
  defaultHome   Home?   @relation("UserDefaultHome", fields: [defaultHomeId], references: [id], onDelete: SetNull)

  // Profile & comms
  profile UserProfile?
  comms   CommunicationPreferences?

  // Settings & notifications
  settings          UserSettings?
  notificationPrefs NotificationPreference[]

  // Community
  ForumThread        ForumThread[]
  ForumPost          ForumPost[]
  ForumVote          ForumVote[]
  ForumPostEdit      ForumPostEdit[]
  ReputationSnapshot ReputationSnapshot[]
}

model UserProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName String?
  lastName  String?
  avatarUrl String?

  timezone String?
  locale   String?
  units    Units?

  householdRole HouseholdRole?
  diySkill      DiySkill?

  tosAcceptedAt     DateTime?
  privacyAcceptedAt DateTime?
  marketingOptInAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommunicationPreferences {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  emailEnabled     Boolean @default(true)
  pushEnabled      Boolean @default(false)
  reminderLeadDays Int     @default(3)
  quietHoursStart  Int     @default(22)
  quietHoursEnd    Int     @default(7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model LoginActivity {
  id        String   @id @default(uuid())
  userId    String
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshSession {
  id           String    @id @default(uuid())
  userId       String
  tokenHash    String
  userAgent    String?
  ip           String?
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime  @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

/* =========================
   Homes, Rooms, Details
   ========================= */

model Home {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserHome", fields: [userId], references: [id])

  address   String
  apartment String?
  city      String
  state     String
  zip       String

  nickname   String?
  squareFeet Int?
  lotSize    Float?
  yearBuilt  Int?

  // Systems / style
  hasCentralAir Boolean @default(false)
  hasBaseboard  Boolean @default(false)
  hasHeatPump   Boolean @default(false)

  roofType           String?
  sidingType         String?
  architecturalStyle String?

  // Align with /shared/types/home.ts
  boilerType          String?
  heatingCoolingTypes String[] @default([])

  numberOfRooms Int?
  features      String[]
  imageUrl      String?

  isChecked Boolean @default(true)
  position  Int?

  latitude  Float?
  longitude Float?
  timeZone  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Composition
  rooms    Room[]    @relation("HomeRooms")
  vehicles Vehicle[] @relation("HomeVehicles")
  lawnProfile LawnProfile?

  // Trackables (current pointers)
  trackables Trackable[] @relation("HomeTrackables")

  // Historical assignment records
  trackableAssignments TrackableAssignment[]

  // Users who default here
  usersDefaultingHere User[]  @relation("UserDefaultHome")

  // Tasks scoped to home
  UserTask UserTask[]
}

model Room {
  id        String   @id @default(cuid())
  name      String
  type      String
  floor     Int?
  createdAt DateTime @default(now())
  position  Int      @default(0)

  homeId String
  home   Home   @relation("HomeRooms", fields: [homeId], references: [id], onDelete: Cascade)

  detail RoomDetail?

  // Trackables (current pointer)
  trackables Trackable[] @relation("RoomTrackables")

  // Tasks scoped to this room
  userTasks UserTask[] @relation("RoomTasks")

  // Assignment history backref
  trackableAssignments TrackableAssignment[]

  @@index([homeId, position])
}

model RoomDetail {
  roomId String @id
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Surfaces
  flooring    FlooringType?
  wallFinish  WallFinish?
  ceilingType CeilingType?

  // Openings
  windowCount     Int?        @default(0)
  windowType      WindowType?
  hasExteriorDoor Boolean?    @default(false)

  // HVAC & lighting
  heatBaseboardHydronic Boolean?     @default(false)
  heatBaseboardElectric Boolean?     @default(false)
  heatRadiator          Boolean?     @default(false)
  hvacSupplyVents       Int?         @default(0)
  hvacReturnVents       Int?         @default(0)
  hasCeilingFan         Boolean?     @default(false)
  ceilingFixture        CeilingFixture?
  recessedLightCount    Int?         @default(0)

  // Electrical
  approxOutletCount Int?     @default(0)
  hasGfci           Boolean? @default(false)

  // Safety
  hasSmokeDetector Boolean? @default(false)
  hasCoDetector    Boolean? @default(false)
  hasFireplace     Boolean? @default(false)

  // Plumbing
  sinkCount           Int?     @default(0)
  toiletCount         Int?     @default(0)
  showerCount         Int?     @default(0)
  tubCount            Int?     @default(0)
  hasRadiantFloorHeat Boolean? @default(false)

  // Access
  hasAtticAccess      Boolean? @default(false)
  hasCrawlspaceAccess Boolean? @default(false)

  // Long-tail
  attributes Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LawnProfile {
  id                  String   @id @default(uuid())
  homeId              String   @unique @map("homeId")
  squareFeet          Int?
  usesLawnService     Boolean? @default(false)
  soilType            String?
  sunExposure         String?
  irrigationInstalled Boolean? @default(false)
  createdAt           DateTime @default(now())

  home Home @relation(fields: [homeId], references: [id], onDelete: Cascade)

  @@map("LawnProfile")
}

model Vehicle {
  id        String   @id @default(cuid())
  homeId    String   @map("homeId")
  nickname  String?
  type      String
  make      String?
  model     String?
  year      Int?
  vin       String?
  mileage   Int?
  imageUrl  String?
  createdAt DateTime @default(now())

  home Home @relation("HomeVehicles", fields: [homeId], references: [id], onDelete: Cascade)

  @@map("Vehicle")
}

/* =========================
   Catalog & Trackables
   ========================= */

model ApplianceCatalog {
  id        String   @id @default(uuid())
  brand     String
  model     String
  type      String
  category  String
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())

  applianceTaskTemplates ApplianceTaskTemplate[]
  trackables             Trackable[]

  @@unique([brand, model])
}

model Trackable {
  id String @id @default(uuid())

  ownerUserId String
  owner       User   @relation("UserOwnsTrackables", fields: [ownerUserId], references: [id], onDelete: Cascade)

  // Current location pointers (optional)
  homeId String? @map("homeId")
  roomId String?
  home   Home?   @relation("HomeTrackables", fields: [homeId], references: [id], onDelete: SetNull)
  room   Room?   @relation("RoomTrackables", fields: [roomId], references: [id], onDelete: SetNull)

  // Catalog match (optional)
  applianceCatalogId String?
  applianceCatalog   ApplianceCatalog? @relation(fields: [applianceCatalogId], references: [id])

  // Per-item overrides
  brand    String? @db.VarChar(128)
  model    String? @db.VarChar(128)
  category String? @db.VarChar(64)
  kind     String? @db.VarChar(64) // normalized slug, e.g., "range-oven"

  userDefinedName String?
  purchaseDate    DateTime?
  serialNumber    String?
  imageUrl        String?
  notes           String?
  attributes      Json?

  status        TrackableStatus @default(IN_USE)
  retiredAt     DateTime?
  retiredReason RetiredReason?

  // Supersession chain
  supersedesId String?
  supersedes   Trackable?  @relation("TrackableSupersession", fields: [supersedesId], references: [id])
  supersededBy Trackable[] @relation("TrackableSupersession")

  // History & resources
  assignments        TrackableAssignment[]
  TrackableResource  TrackableResource[]

  // Tasks
  tasks UserTask[] @relation("TrackableTasks")

  // Provenance
  isGeneric   Boolean        @default(true)
  detailLevel DetailLevel    @default(generic)
  source      TrackableSource @default(user_manual_entry)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerUserId])
  @@index([status])
  @@index([applianceCatalogId])
  @@index([supersedesId])
  @@index([brand])
  @@index([model])
  @@index([category])
  @@index([kind])
  @@index([ownerUserId, homeId])
  @@index([roomId, kind, status]) // de-dupe helper
}

model TrackableAssignment {
  id          String    @id @default(cuid())
  trackableId String
  homeId      String?
  roomId      String?
  startAt     DateTime  @default(now())
  endAt       DateTime?

  trackable Trackable @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  home      Home?     @relation(fields: [homeId], references: [id], onDelete: SetNull)
  room      Room?     @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@index([trackableId, endAt])
  @@index([homeId])
  @@index([roomId])
}

model TrackableResource {
  id          String                @id @default(uuid())
  trackableId String
  trackable   Trackable             @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  type        TrackableResourceType
  name        String
  filePath    String?
  url         String?
  createdAt   DateTime              @default(now())

  @@index([trackableId])
}

/* =========================
   Tasks & Templates
   ========================= */

model TaskTemplate {
  id                 String          @id @default(uuid())
  title              String
  description        String?
  icon               String?
  imageUrl           String?
  category           String?
  recurrenceInterval String
  taskType           TaskType
  criticality        TaskCriticality @default(medium)

  canDefer             Boolean @default(true)
  deferLimitDays       Int     @default(0)
  estimatedTimeMinutes Int     @default(30)
  estimatedCost        Int     @default(0)
  canBeOutsourced      Boolean @default(false)

  steps           String[] @default([])
  equipmentNeeded String[] @default([])
  resources       Json?

  version   Int           @default(1)
  state     TemplateState @default(DRAFT)
  changelog String?
  updatedBy String?
  updatedAt DateTime      @updatedAt

  createdAt DateTime @default(now())

  userTasks                    UserTask[]
  ApplianceTaskTemplate        ApplianceTaskTemplate[]
  TrackableKindTaskTemplate    TrackableKindTaskTemplate[]
}

model ApplianceTaskTemplate {
  id                 String  @id @default(uuid())
  applianceCatalogId String
  taskTemplateId     String
  notes              String?

  applianceCatalog ApplianceCatalog @relation(fields: [applianceCatalogId], references: [id], onDelete: Cascade)
  taskTemplate     TaskTemplate     @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)

  @@unique([applianceCatalogId, taskTemplateId])
}

model TrackableKindTaskTemplate {
  id             String       @id @default(uuid())
  kind           String       // e.g., "dishwasher", "water-heater"
  category       String?
  taskTemplateId String
  taskTemplate   TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)

  @@unique([kind, taskTemplateId])
  @@index([kind])
}

model UserTask {
  id             String             @id @default(uuid())
  userId         String
  homeId         String?
  roomId         String?
  trackableId    String?
  taskTemplateId String?
  sourceType     UserTaskSourceType

  title         String
  description   String
  dueDate       DateTime
  completedDate DateTime?
  status        TaskStatus

  // Lifecycle
  pausedAt   DateTime?
  archivedAt DateTime?

  // Provenance & adoption
  sourceTemplateVersion Int?
  overriddenFields      Json? // string[]

  itemName String
  category String
  location String?

  estimatedTimeMinutes Int             @default(0)
  estimatedCost        Int             @default(0)
  criticality          TaskCriticality @default(medium)

  deferLimitDays  Int     @default(0)
  canBeOutsourced Boolean @default(false)
  canDefer        Boolean @default(true)
  isTracking      Boolean @default(true)

  recurrenceInterval String   @default("")
  taskType           TaskType @default(GENERAL)

  dedupeKey String @unique

  steps           Json?
  equipmentNeeded Json?
  resources       Json?
  stepProgress    Json? // { [stepId]: { checked: boolean, note?: string } }

  imageUrl String?
  icon     String?

  createdAt DateTime @default(now())

  // relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  home         Home?         @relation(fields: [homeId], references: [id], onDelete: SetNull)
  room         Room?         @relation("RoomTasks", fields: [roomId], references: [id], onDelete: SetNull)
  trackable    Trackable?    @relation("TrackableTasks", fields: [trackableId], references: [id], onDelete: SetNull)
  taskTemplate TaskTemplate? @relation(fields: [taskTemplateId], references: [id])
  dismissals   DismissedUserTask[]

  snapshots TaskSnapshotHistory[]

  @@index([userId, status, dueDate], name: "idx_usertask_user_status_due")
  @@index([roomId], name: "idx_usertask_room")
  @@index([trackableId], name: "idx_usertask_trackable")
  @@index([taskTemplateId], name: "idx_usertask_template")
  @@index([pausedAt, archivedAt])
  @@index([userId, completedDate])
  @@index([homeId])
  @@index([userId, homeId, status, dueDate])
}

model TaskSnapshotHistory {
  id             String   @id @default(cuid())
  userTaskId     String
  fromVersion    Int?
  toVersion      Int?
  fieldsChanged  Json?
  snapshotBefore Json?
  snapshotAfter  Json?
  appliedAt      DateTime @default(now())

  userTask UserTask @relation(fields: [userTaskId], references: [id], onDelete: Cascade)

  @@index([userTaskId, appliedAt])
}

model DismissedUserTask {
  id         String   @id @default(cuid())
  userId     String
  userTaskId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userTask UserTask @relation(fields: [userTaskId], references: [id], onDelete: Cascade)

  @@unique([userId, userTaskId])
}

/* =========================
   Billing / Misc
   ========================= */

model BillingAccount {
  id               String    @id @default(uuid())
  userId           String    @unique
  stripeCustomerId String?
  plan             String
  status           String
  trialEndsAt      DateTime?
  createdAt        DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AIQueryHistory {
  id              String   @id @default(uuid())
  userId          String?
  query           String
  source          String?
  responseSummary String?
  createdAt       DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WhatsNew {
  id          String   @id @default(uuid())
  title       String
  description String
  createdAt   DateTime @default(now())
  published   Boolean  @default(true)
}

/* =========================
   Lifecycle & Rules
   ========================= */

model LifecycleEvent {
  id        String   @id @default(cuid())
  userId    String
  entity    String
  entityId  String
  action    String
  metadata  Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, entity, action, createdAt])
}

/* ----- Task Generation Issues (Admin) ----- */

enum TaskGenIssueStatus {
  open
  in_progress
  resolved
}

enum TaskGenIssueCode {
  no_matching_template
  enrichment_lookup_failed
  template_eval_error
  upsert_error
}

model TaskGenerationIssue {
  id          String  @id @default(cuid())
  userId      String
  homeId      String?
  roomId      String?
  trackableId String?

  code         TaskGenIssueCode
  status       TaskGenIssueStatus @default(open)
  message      String?
  debugPayload Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([homeId])
  @@index([trackableId])
  @@index([code, status])
}

/* ----- DB-backed TaskGen Rules ----- */

enum RuleScope {
  home
  room
  trackable
}

enum ConditionTarget {
  home
  room
  room_detail
  trackable
}

enum ConditionOp {
  eq
  ne
  contains
  not_contains
  exists
  not_exists
  gte
  lte
  in
  not_in
}

model TaskGenRule {
  id      String    @id @default(cuid())
  key     String    @unique
  scope   RuleScope
  enabled Boolean   @default(true)

  reevalOn String[] @default([])

  template   TaskGenRuleTemplate?
  conditions TaskGenRuleCondition[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TaskGenRuleTemplate {
  id     String      @id @default(cuid())
  ruleId String      @unique
  rule   TaskGenRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  title              String
  description        String?
  icon               String?
  imageUrl           String?
  category           String?
  recurrenceInterval String
  taskType           TaskType        @default(GENERAL)
  criticality        TaskCriticality @default(medium)

  canDefer             Boolean @default(true)
  deferLimitDays       Int     @default(0)
  estimatedTimeMinutes Int     @default(30)
  estimatedCost        Int     @default(0)
  canBeOutsourced      Boolean @default(false)

  steps           String[] @default([])
  equipmentNeeded String[] @default([])
  resources       Json?
}

model TaskGenRuleCondition {
  id     String      @id @default(cuid())
  ruleId String
  rule   TaskGenRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  target ConditionTarget
  field  String
  op     ConditionOp
  value  String?
  values String[]

  idx Int @default(0)

  @@index([ruleId, idx])
}

/* =========================
   Community & Gamification
   ========================= */

model ForumCategory {
  id          String        @id @default(uuid())
  slug        String        @unique
  name        String
  description String?
  order       Int           @default(0)
  threads     ForumThread[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ForumThread {
  id             String        @id @default(uuid())
  categoryId     String
  category       ForumCategory @relation(fields: [categoryId], references: [id])
  authorId       String
  author         User          @relation(fields: [authorId], references: [id])
  title          String
  type           ThreadType    @default(discussion)
  trackableId    String?
  taskTemplateId String?
  status         ThreadStatus  @default(open)
  pinned         Boolean       @default(false)
  locked         Boolean       @default(false)
  score          Int           @default(0)
  posts          ForumPost[]
  tags           ForumTagOnThread[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // fast counts
  commentCount   Int      @default(0)
  lastPostAt     DateTime?
  ForumVote      ForumVote[]
}

enum ThreadType {
  discussion
  bug
  tip
  correction
}

enum ThreadStatus {
  open
  acknowledged
  in_progress
  resolved
  rejected
}

model ForumPost {
  id        String       @id @default(uuid())
  threadId  String
  thread    ForumThread  @relation(fields: [threadId], references: [id])
  authorId  String
  author    User         @relation(fields: [authorId], references: [id])
  body      String
  score     Int          @default(0)
  isAnswer  Boolean      @default(false)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  edits     ForumPostEdit[]
  ForumVote ForumVote[]
}

model ForumVote {
  id        String       @id @default(uuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  postId    String?
  post      ForumPost?   @relation(fields: [postId], references: [id])
  threadId  String?
  thread    ForumThread? @relation(fields: [threadId], references: [id])
  value     Int
  createdAt DateTime     @default(now())

  // NOTE: With nullable FKs, these uniques do not protect against multiple NULL rows in Postgres.
  // Add a migration with:
  //   - CHECK ((post_id IS NOT NULL) <> (thread_id IS NOT NULL))
  //   - two partial unique indexes WHERE post_id IS NOT NULL / WHERE thread_id IS NOT NULL
  @@unique([userId, postId])
  @@unique([userId, threadId])
}

model ForumTag {
  id               String             @id @default(uuid())
  slug             String             @unique
  label            String
  ForumTagOnThread ForumTagOnThread[]
}

model ForumTagOnThread {
  threadId String
  tagId    String
  thread   ForumThread @relation(fields: [threadId], references: [id])
  tag      ForumTag    @relation(fields: [tagId], references: [id])

  @@id([threadId, tagId])
}

model ForumPostEdit {
  id        String    @id @default(uuid())
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id])
  editorId  String
  editor    User      @relation(fields: [editorId], references: [id])
  prevBody  String
  newBody   String
  createdAt DateTime  @default(now())
}

model ReputationSnapshot {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  totalXP   Int      @default(0)
  level     Int      @default(1)
  updatedAt DateTime @updatedAt
}

model GamificationEvent {
  id        String   @id @default(uuid())
  userId    String
  kind      String
  refType   String
  refId     String
  deltaXP   Int
  createdAt DateTime @default(now())

  @@unique([userId, kind, refType, refId])
}

/* =========================
   Settings & Notifications
   ========================= */

enum TaskDetailView {
  drawer
  card
}

model UserSettings {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Appearance
  theme       ThemeMode @default(SYSTEM)
  accentColor String    @default("#4f46e5")
  fontScale   Float     @default(1.0)

  // Gamification
  gamificationEnabled         Boolean                @default(true)
  gamificationVisibility      GamificationVisibility @default(PRIVATE)
  retainDeletedTrackableStats Boolean                @default(true)

  // Task defaults
  defaultDaysBeforeDue  Int           @default(2)
  autoAssignRoomTasks   Boolean       @default(true)
  allowTaskDisable      Boolean       @default(true)
  allowTaskDelete       Boolean       @default(true)
  taskDetailView        TaskDetailView @default(drawer)

  // Integrations
  googleCalendarEnabled Boolean @default(false)
  icalFeedToken         String?  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationPreference {
  id          String                @id @default(cuid())
  userId      String
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  event       NotificationEvent
  channel     NotificationChannel
  enabled     Boolean               @default(true)
  frequency   NotificationFrequency @default(IMMEDIATE)

  // Optional scoping
  homeId      String?
  trackableId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, event, channel, homeId, trackableId])
  @@index([userId, event, channel])
}
