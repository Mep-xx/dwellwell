generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Units {
  imperial
  metric
}

enum HouseholdRole {
  owner
  renter
  property_manager
}

enum DiySkill {
  none
  beginner
  intermediate
  pro
}

enum AuthProvider {
  local
  google
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String?   // null for SSO users
  authProvider      AuthProvider @default(local)
  passwordUpdatedAt DateTime?
  failedLoginCount  Int      @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime @default(now())

  googleId          String?  @unique

  homes             Home[] @relation("UserHomes")

  loginActivities   LoginActivity[]
  billingAccount    BillingAccount?
  userTasks         UserTask[]
  aiQueries         AIQueryHistory[]
  dismissedTasks    DismissedUserTask[]
  role              String              @default("user")

  defaultHomeId     String?
  defaultHome       Home?   @relation("UserDefaultHome", fields: [defaultHomeId], references: [id], onDelete: SetNull)

  profile           UserProfile?
  comms             CommunicationPreferences?

  refreshSessions   RefreshSession[]
}

/* unchanged models below except where noted */

model LoginActivity {
  id        String   @id @default(uuid())
  userId    String
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshSession {
  id           String   @id @default(uuid())
  userId       String
  tokenHash    String
  userAgent    String?
  ip           String?
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Home {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation("UserHomes", fields: [userId], references: [id])

  address            String
  apartment          String?
  city               String
  state              String
  zip                String

  nickname           String?
  squareFeet         Int?
  lotSize            Float?
  yearBuilt          Int?

  hasCentralAir      Boolean  @default(false)
  hasBaseboard       Boolean  @default(false)
  hasHeatPump        Boolean  @default(false)

  roofType           String?
  sidingType         String?
  architecturalStyle String?
  numberOfRooms      Int?
  features           String[]
  imageUrl           String?

  isChecked          Boolean  @default(true)

  latitude           Float?
  longitude          Float?
  timeZone           String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  rooms              Room[]      @relation("HomeRooms")
  vehicles           Vehicle[]   @relation("HomeVehicles")
  trackables         Trackable[] @relation("HomeTrackables")
  lawnProfile        LawnProfile?

  usersDefaultingHere User[] @relation("UserDefaultHome")
}

model Room {
  id               String   @id @default(cuid())
  name             String
  type             String
  floor            Int?
  hasFireplace     Boolean  @default(false)
  hasBoiler        Boolean  @default(false)
  hasSmokeDetector Boolean  @default(false)
  createdAt        DateTime @default(now())

  position         Int @default(0)

  home             Home        @relation("HomeRooms", fields: [homeId], references: [id], onDelete: Cascade)
  homeId           String
  trackables       Trackable[] @relation("RoomTrackables")
  userTasks        UserTask[]  @relation("RoomTasks")

  @@index([homeId, position])
}

model LawnProfile {
  id                  String   @id @default(uuid())
  homeId              String   @unique
  squareFeet          Int?
  usesLawnService     Boolean? @default(false)
  soilType            String?
  sunExposure         String?
  irrigationInstalled Boolean? @default(false)
  createdAt           DateTime @default(now())

  home Home @relation(fields: [homeId], references: [id], onDelete: Cascade)
}

model Vehicle {
  id        String   @id @default(cuid())
  homeId    String
  nickname  String?
  type      String
  make      String?
  model     String?
  year      Int?
  vin       String?
  mileage   Int?
  imageUrl  String?
  createdAt DateTime @default(now())

  home Home @relation("HomeVehicles", fields: [homeId], references: [id], onDelete: Cascade)
}

model ApplianceCatalog {
  id        String   @id @default(uuid())
  brand     String
  model     String
  type      String
  category  String
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())

  applianceTaskTemplates ApplianceTaskTemplate[]
  trackables             Trackable[]

  @@unique([brand, model])
}

model Trackable {
  id                 String    @id @default(uuid())
  homeId             String
  roomId             String?
  applianceCatalogId String?
  userDefinedName    String?
  purchaseDate       DateTime?
  serialNumber       String?
  imageUrl           String?
  notes              String?
  createdAt          DateTime  @default(now())

  kind               String?

  attributes         Json?

  home               Home              @relation("HomeTrackables", fields: [homeId], references: [id], onDelete: Cascade)
  room               Room?             @relation("RoomTrackables", fields: [roomId], references: [id], onDelete: Cascade)
  applianceCatalog   ApplianceCatalog? @relation(fields: [applianceCatalogId], references: [id])

  tasks              UserTask[]          @relation("TrackableTasks")
  TrackableResource  TrackableResource[]
}

model TaskTemplate {
  id                 String          @id @default(uuid())
  title              String
  description        String?
  icon               String?
  imageUrl           String?
  category           String?
  recurrenceInterval String
  taskType           TaskType
  criticality        TaskCriticality @default(medium)

  canDefer             Boolean @default(true)
  deferLimitDays       Int     @default(0)
  estimatedTimeMinutes Int     @default(30)
  estimatedCost        Int     @default(0)
  canBeOutsourced      Boolean @default(false)

  steps           String[] @default([])
  equipmentNeeded String[] @default([])
  resources       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userTasks             UserTask[]
  ApplianceTaskTemplate ApplianceTaskTemplate[]
}

model ApplianceTaskTemplate {
  id                 String  @id @default(uuid())
  applianceCatalogId String
  taskTemplateId     String
  notes              String?

  applianceCatalog ApplianceCatalog @relation(fields: [applianceCatalogId], references: [id], onDelete: Cascade)
  taskTemplate     TaskTemplate     @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)

  @@unique([applianceCatalogId, taskTemplateId])
}

enum UserTaskSourceType {
  room
  trackable
}

model UserTask {
  id                  String             @id @default(uuid())
  userId              String
  roomId              String?
  trackableId         String?
  taskTemplateId      String?
  sourceType          UserTaskSourceType

  title               String
  description         String
  dueDate             DateTime
  completedDate       DateTime?
  status              TaskStatus

  itemName            String
  category            String
  location            String?

  estimatedTimeMinutes Int             @default(0)
  estimatedCost        Int             @default(0)
  criticality          TaskCriticality @default(medium)

  deferLimitDays       Int     @default(0)
  canBeOutsourced      Boolean @default(false)
  canDefer             Boolean @default(true)
  isTracking           Boolean @default(true)

  recurrenceInterval   String @default("")

  taskType            TaskType @default(GENERAL)

  dedupeKey           String @unique

  steps               Json?
  equipmentNeeded     Json?
  resources           Json?

  imageUrl            String?
  icon                String?

  createdAt           DateTime @default(now())

  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  room                Room?               @relation("RoomTasks", fields: [roomId], references: [id], onDelete: Cascade)
  trackable           Trackable?          @relation("TrackableTasks", fields: [trackableId], references: [id], onDelete: Cascade)
  taskTemplate        TaskTemplate?       @relation(fields: [taskTemplateId], references: [id])
  dismissals          DismissedUserTask[]

  @@index([userId, status, dueDate], name: "idx_usertask_user_status_due")
  @@index([roomId], name: "idx_usertask_room")
  @@index([trackableId], name: "idx_usertask_trackable")
  @@index([taskTemplateId], name: "idx_usertask_template")
}

model DismissedUserTask {
  id         String   @id @default(cuid())
  userId     String
  userTaskId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userTask UserTask @relation(fields: [userTaskId], references: [id], onDelete: Cascade)

  @@unique([userId, userTaskId])
}

model BillingAccount {
  id               String    @id @default(uuid())
  userId           String    @unique
  stripeCustomerId String?
  plan             String
  status           String
  trialEndsAt      DateTime?
  createdAt        DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AIQueryHistory {
  id              String   @id @default(uuid())
  userId          String?
  query           String
  source          String?
  responseSummary String?
  createdAt       DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum TaskStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum TaskCriticality {
  low
  medium
  high
}

enum TaskType {
  GENERAL
  AI_GENERATED
  USER_DEFINED
}

model UserProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName String?
  lastName  String?
  avatarUrl String?

  timezone String?
  locale   String?
  units    Units?

  householdRole HouseholdRole?
  diySkill      DiySkill?

  tosAcceptedAt     DateTime?
  privacyAcceptedAt DateTime?
  marketingOptInAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommunicationPreferences {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  emailEnabled     Boolean @default(true)
  pushEnabled      Boolean @default(false)
  reminderLeadDays Int     @default(3)
  quietHoursStart  Int     @default(22)
  quietHoursEnd    Int     @default(7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsNew {
  id          String   @id @default(uuid())
  title       String
  description String
  createdAt   DateTime @default(now())
  published   Boolean  @default(true)
}

enum TrackableResourceType {
  pdf
  video
}

model TrackableResource {
  id          String                @id @default(uuid())
  trackable   Trackable             @relation(fields: [trackableId], references: [id], onDelete: Cascade)
  trackableId String
  type        TrackableResourceType
  name        String
  filePath    String?
  url         String?
  createdAt   DateTime              @default(now())

  @@index([trackableId])
}
